"""
ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ูู ูููุงุช ุฃูุงูุฑ ุงูุชูุฑูุฏ (Word)
"""

import re
from docx import Document

def extract_text_from_docx(file_path):
    """
    ุงุณุชุฎุฑุงุฌ ุงููุต ุงููุงูู ูู ููู Word
    """
    try:
        doc = Document(file_path)
        # ุฌูุน ูู ุงูููุฑุงุช
        paragraphs = [p.text for p in doc.paragraphs]
        # ุฌูุน ุงููุตูุต ูู ุงูุฌุฏุงูู ุฃูุถุงู
        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    paragraphs.append(cell.text)
        
        full_text = '\n'.join(paragraphs)
        return full_text
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: {e}")
        return None


def clean_text(text):
    """
    ุชูุธูู ุงููุต ูู ุงููุฑุงุบุงุช ุงูุฒุงุฆุฏุฉ
    """
    # ุฅุฒุงูุฉ ุงููุฑุงุบุงุช ุงููุชุนุฏุฏุฉ
    text = re.sub(r'\s+', ' ', text)
    return text.strip()


def extract_order_data(file_path):
    """
    ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุงููุทููุจุฉ ูู ููู ุฃูุฑ ุงูุชูุฑูุฏ
    
    Returns:
        dict: ูุงููุณ ูุญุชูู ุนูู ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ
    """
    # ูุฑุงุกุฉ ุงููุต ูู ุงูููู
    text = extract_text_from_docx(file_path)
    
    if not text:
        return None
    
    # ุชูุธูู ุงููุต
    text = clean_text(text)
    
    # ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ
    data = {
        'ุฑูู_ุงูุฃูุฑ': '',
        'ุงูุชุงุฑูุฎ': '',
        'ุงุณู_ุงูุดุฑูุฉ': '',
        'ุงูุจูุงู': '',
        'ุงูุฌูุฉ_ุงูุทุงูุจุฉ': '',
        'ุงููุจูุบ_ุงูุฅุฌูุงูู': ''
    }
    
    # 1๏ธโฃ ุงุณุชุฎุฑุงุฌ ุฑูู ุงูุฃูุฑ
    order_match = re.search(r'ุฃูุฑ\s+ุชูุฑูุฏ\s+ุฑูู\s*\((\d+)\)', text)
    if order_match:
        data['ุฑูู_ุงูุฃูุฑ'] = order_match.group(1)
    
    # 2๏ธโฃ ุงุณุชุฎุฑุงุฌ ุงูุชุงุฑูุฎ
    date_match = re.search(r'ุงููุงู[ููู]*ุฑุฉ\s+(?:ูู|ูู)\s+(\d{1,2}/\d{1,2}/\d{4})', text)
    if date_match:
        data['ุงูุชุงุฑูุฎ'] = date_match.group(1)
    
    # 3๏ธโฃ ุงุณุชุฎุฑุงุฌ ุงุณู ุงูุดุฑูุฉ
    # ุงูููุท ุงูุฌุฏูุฏ: ูุญู ูุดููุฉ (ู/ุฉ) ูููุชูุท ุงูุงุณู ุญุชู ุฃูู ุธููุฑ ููุนููุงู (\d ุด) ุฃู ููุงูุฉ ุงูุณุทุฑ
    company_match = re.search(
        r'ุงูุณุงุฏ[ูุฉ]\s*/\s*(.+?)(?=\s*\d{1,3}\s*[ุด]|[,\.\n]|\Z)', 
        text, 
        re.DOTALL
    )

    if company_match:
        # 1. ุงูุชูุงุท ุงูุงุณู ูุจุงุดุฑุฉ ูู ุงููุฌููุนุฉ ุงูุฃููู ูุชุฌุฑูุฏู ูู ุงููุณุงูุงุช
        company_name = company_match.group(1).strip()
        
        # 2. ุชูุธูู ุฅุถุงูู ูุฅุฒุงูุฉ ุงููุณุงูุงุช ูุงูููุงุตู ุงูุณุทุฑูุฉ ุงูุฒุงุฆุฏุฉ
        company_name = company_name.replace('\r', ' ').replace('\n', ' ').strip()
        
        # 3. ุฎุทูุฉ ุญุงุณูุฉ: ุฅุฐุง ูุงูุช ุงููููุฉ ุทูููุฉ ุฌุฏุงู (ุฃูุซุฑ ูู 150 ุญุฑูุงู)ุ 
        # ููุฐุง ูุนูู ุฃููุง ุงูุชูุทุช ูุตุงู ููุฑุฑุงู. ูููู ุจุชูุณูู ุงููุต ุนูุฏ ุฃูู ุธููุฑ ููููุฉ "ุงูุณุงุฏุฉ" ุฃู "ุงูุณุงุฏู" 
        # ููุฃุฎุฐ ุงูุฌุฒุก ุงูุฃูู ููุท (ููู ุงูุงุณู ุงูุตุญูุญ).
        if len(company_name) > 150:
            parts = re.split(r'ุงูุณุงุฏ[ูุฉ]\s*/', company_name, 1)
            company_name = parts[0].strip() if parts else company_name
            
        data['ุงุณู_ุงูุดุฑูุฉ'] = company_name
    # 4๏ธโฃ ุงุณุชุฎุฑุงุฌ ุงูุจูุงู ูุงูุฌูุฉ ุงูุทุงูุจุฉ ูุนุงู
    description_match = re.search(
        r'ุจุฎุตูุต\s+(.+?)(?=\s*ุฑุฌูุงุก|\s*ุงูุฅุญุงุทุฉ|\s*ุจุงูุดุฑูุท)',
        text,
        re.DOTALL
    )
    if description_match:
        full_description = description_match.group(1).strip()
        
        # ุงุณุชุฎุฑุงุฌ ุงูุฌูุฉ ุงูุทุงูุจุฉ ูู ุงูุจูุงู (ุชู ุชุนุฏูู ุฃููุงุท ุงูุงูุชูุงุท ูุชุฌุงูู ุญุฑู 'ูู')
# ุงุณุชุฎุฑุงุฌ ุงูุฌูุฉ ุงูุทุงูุจุฉ ูู ุงูุจูุงู
        dept_patterns = [
            # 1. ููุชูุท ุงูุฌููุฉ ุงููุงููุฉ ุงูุชู ุชุจุฏุฃ ุจู "ุงูุชุงุจุน"
            r'(ุงูุชุงุจุน[ุฉููู]?\s+ู[^.]+?)(?=ุจููุทูุฉ|\.|$)', 
            # 2. ููุชูุท ูุทุงุน ุงูููุงูุฉ (ุจุฏูู ุญุฑู ุงูุฌุฑ ูู)
            r'ู(ูุทุงุน[^.]+?)(?=ุจููุทูุฉ|\.|$)', 
            # 3. ููุชูุท ุงูุฅุฏุงุฑุฉ/ุงูุงุฏุงุฑุฉ (ุจุฏูู ุญุฑู ุงูุฌุฑ ูู)
            r'ู(ูุฅุฏุงุฑุฉ[^.]+?)(?=ุจููุทูุฉ|\.|$)', 
            r'ู(ูุงุฏุงุฑุฉ[^.]+?)(?=ุจููุทูุฉ|\.|$)', 
        ]
        
        department = ''
        for pattern in dept_patterns:
            dept_match = re.search(pattern, full_description, re.DOTALL)
            if dept_match:
                # ูุณุชุฎุฏู group(1) ูุฃููุง ูุถุนูุง ููุณ ุงูุงูุชูุงุท ุญูู ุงุณู ุงูุฌูุฉ ููุท
                department = dept_match.group(1).strip()
                break
        
        data['ุงูุจูุงู'] = full_description
        data['ุงูุฌูุฉ_ุงูุทุงูุจุฉ'] = department
    
    # 5๏ธโฃ ุงุณุชุฎุฑุงุฌ ุงููุจูุบ ุงูุฅุฌูุงูู (ูุจูู ููุง ูู)
    amount_patterns = [
        # ุงูููุท ุงูุฃูุซุฑ ุฏูุฉ: ุงุณุชุฎุฑุงุฌ ุงููุจูุบ ูู ุฌููุฉ "ุจูููุฉ ุฅุฌูุงููู ูุฏุฑูุง X ุฌููู" ุฃู "ุจูุจูุบ ุฅุฌูุงูู ููุฏุฑู X ุฌููู"
        r'(?:ุจูููุฉ ุฅุฌูุงููู ูุฏุฑูุง|ุจูุจูุบ ุฅุฌูุงูู ููุฏุฑู)\s*(\d{1,3}(?:,?\d{3})*\.?\d{0,2})\s*ุฌููู',
        # ููุท ุงุญุชูุงุทู ุนุงู: ูุจุญุซ ุนู ุฃู ุฑูู ูุชุจูุน ุจู "ุฌููู" (ุฅุฐุง ูุดู ุงูุฃูู)
        r'(\d{1,3}(?:,?\d{3})*\.?\d{0,2})\s*ุฌููู'
    ]
    
    for pattern in amount_patterns:
        amount_match = re.search(pattern, text, re.IGNORECASE)
        if amount_match:
            data['ุงููุจูุบ_ุงูุฅุฌูุงูู'] = amount_match.group(1)
            break
    
    return data

def print_extracted_data(data):
    """
    ุทุจุงุนุฉ ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ ุจุดูู ููุณู
    """
    print("\n" + "="*60)
    print("๐ ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ:")
    print("="*60)
    
    if not data:
        print("โ ูู ูุชู ุงุณุชุฎุฑุงุฌ ุฃู ุจูุงูุงุช")
        return
    
    for key, value in data.items():
        print(f"โ {key}: {value}")
    
    print("="*60 + "\n")


# ููุงุฎุชุจุงุฑ ุงููุจุงุดุฑ
if __name__ == "__main__":
    # ...    # ุถุน ูุณุงุฑ ููู Word ููุง ููุงุฎุชุจุงุฑ
    test_file = "test_order.docx"  # ุบูุฑ ุงูุงุณู ููููู
    
    print("๐ ุฌุงุฑู ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช...")
    data = extract_order_data(test_file)
    print_extracted_data(data)